<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comondi - توصيل الطلبات</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #FF5722;
            --secondary: #2196F3;
            --bg: #f4f6f8;
            --text: #333;
            --card-bg: rgba(255, 255, 255, 0.95); /* شفافية بسيطة */
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; overflow-x: hidden; color: var(--text); }

        /* --- 1. الخلفية المتحركة --- */
        .bg-animation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: url('https://images.unsplash.com/photo-1613243555988-441166d4d6fd?q=80&w=1770&auto=format&fit=crop') no-repeat center center/cover;
            animation: zoomEffect 20s infinite alternate;
        }
        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: rgba(0, 0, 0, 0.5); /* تغميق الخلفية */
        }
        @keyframes zoomEffect {
            0% { transform: scale(1); }
            100% { transform: scale(1.2); }
        }

        /* --- 2. شاشة البداية (Splash Screen) --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            background: #fff;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.8s ease-out;
        }
        .splash-icons { display: flex; gap: 40px; font-size: 60px; margin-bottom: 20px; }
        .icon-anim { animation: bounceIn 1.5s infinite alternate; }
        .icon-anim:nth-child(2) { animation-delay: 0.2s; color: var(--primary); }
        .icon-anim:nth-child(1) { color: var(--secondary); }
        
        @keyframes bounceIn {
            0% { transform: translateY(0); opacity: 0.5; }
            100% { transform: translateY(-20px); opacity: 1; }
        }

        /* --- التنسيقات العامة --- */
        .screen { display: none; padding: 25px; max-width: 450px; margin: 40px auto; min-height: 80vh; 
                  background: var(--card-bg); border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
                  backdrop-filter: blur(5px); }
        .active-screen { display: block; animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* العناصر */
        h1 { color: var(--primary); font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); margin-bottom: 10px; }
        input, select, button { width: 100%; padding: 14px; margin-top: 8px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 16px; box-shadow: 0 4px 6px rgba(255,87,34,0.3); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(255,87,34,0.4); }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-card { background: #fff; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        #map-customer, #map-rider { height: 300px; width: 100%; border-radius: 12px; margin-top: 15px; border: 2px solid #fff; }
        .order-card { background: #fff; border-right: 5px solid var(--primary); padding: 15px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { color: #d32f2f; background: #ffcdd2; padding: 10px; border-radius: 5px; text-align: center; display: none; margin-top: 10px; font-size: 0.9em; }
    </style>
</head>
<body>

    <!-- الخلفية المتحركة -->
    <div class="bg-animation"></div>
    <div class="bg-overlay"></div>

    <!-- شاشة الترحيب (Splash) -->
    <div id="splash-screen">
        <div class="splash-icons">
            <i class="fas fa-motorcycle icon-anim"></i>
            <i class="fas fa-user icon-anim"></i>
        </div>
        <h2 style="color:#333;">Comondi</h2>
        <p>توصيل طعام سريع..</p>
    </div>

    <!-- الصوت -->
    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <!-- 1. شاشة تسجيل الدخول -->
    <div id="screen-login" class="screen">
        <h1>Comondi</h1>
        <h3 style="color:#555;">مرحباً بعودتك</h3>
        
        <input type="email" id="login-email" placeholder="البريد الإلكتروني">
        <input type="password" id="login-pass" placeholder="كلمة المرور">
        
        <button onclick="handleLogin()" id="btn-login">تسجيل الدخول</button>
        <p id="login-error" class="error-msg"></p>
        
        <div style="text-align:center; margin-top:20px;">
            <span onclick="showScreen('screen-register')" style="color:var(--secondary); cursor:pointer; text-decoration:underline;">إنشاء حساب جديد</span>
        </div>
    </div>

    <!-- 2. شاشة التسجيل -->
    <div id="screen-register" class="screen">
        <h2>حساب جديد</h2>
        <select id="reg-role">
            <option value="customer">أنا زبون (Client)</option>
            <option value="rider">أنا موصل (Livreur)</option>
        </select>
        <input type="text" id="reg-name" placeholder="الاسم الكامل">
        <input type="tel" id="reg-phone" placeholder="رقم الهاتف">
        <input type="email" id="reg-email" placeholder="البريد الإلكتروني">
        <input type="password" id="reg-pass" placeholder="كلمة المرور (6+ أحرف)">
        
        <button onclick="handleRegister()" id="btn-register">إنشاء الحساب</button>
        <p id="reg-error" class="error-msg"></p>
        
        <div style="text-align:center; margin-top:15px;">
            <span onclick="showScreen('screen-login')" style="color:var(--secondary); cursor:pointer;">لديك حساب بالفعل؟</span>
        </div>
    </div>

    <!-- 3. شاشة الزبون -->
    <div id="screen-customer" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="cust-welcome" style="margin:0">أهلاً</h3>
            <button onclick="logout()" style="width:auto; padding:5px 15px; margin:0; background:#777;">خروج</button>
        </div>
        <hr style="margin:15px 0; border:0; border-top:1px solid #ddd;">
        
        <h3>اطلب الآن</h3>
        <input type="text" id="food-name" placeholder="اسم الأكل (بيتزا، طاكوس..)">
        <input type="text" id="drink-name" placeholder="مشروب (اختياري)">
        <input type="text" id="store-name" placeholder="اسم المحل">
        
        <button onclick="createOrder()" id="btn-order-now">اطلب وشارك موقعك <i class="fas fa-location-arrow"></i></button>
        <div id="gps-loader" class="loader"></div>
        <p id="gps-error" class="error-msg"></p>
    </div>

    <!-- 4. شاشة التتبع للزبون -->
    <div id="screen-tracking" class="screen">
        <h3>حالة الطلب</h3>
        <div style="background:#e3f2fd; padding:15px; border-radius:10px; text-align:center; color:var(--secondary); font-weight:bold;">
            <span id="order-status-text">بانتظار القبول...</span>
        </div>
        
        <div id="rider-info-box" style="display:none; margin-top:10px; background:#fff8e1; padding:10px; border-radius:8px;">
            <p><i class="fas fa-motorcycle"></i> الموصل: <b id="rider-name-display"></b></p>
            <p><i class="fas fa-phone"></i> <b id="rider-phone-display"></b></p>
        </div>

        <div id="map-customer"></div>
        <img id="customer-invoice-view" src="" style="width:100%; border-radius:10px; margin-top:10px; display:none;">
    </div>

    <!-- 5. داشبورد الموصل -->
    <div id="screen-rider-dashboard" class="screen">
        <div style="display:flex; justify-content:space-between;">
            <h3 id="rider-welcome" style="margin:0">لوحة التحكم</h3>
            <button onclick="logout()" style="width:auto; background:#777; padding:5px 10px; margin:0;"><i class="fas fa-sign-out-alt"></i></button>
        </div>

        <div class="dashboard-grid">
            <div class="stat-card"><i class="fas fa-check fa-2x" style="color:green;"></i><h4 id="stat-comp">0</h4><small>مكتملة</small></div>
            <div class="stat-card"><i class="fas fa-coins fa-2x" style="color:gold;"></i><h4 id="stat-earn">0</h4><small>الأرباح</small></div>
        </div>

        <h4>الطلبات الجديدة</h4>
        <div id="orders-list">
            <p style="text-align:center; color:#999;">لا توجد طلبات حالياً</p>
        </div>
    </div>

    <!-- 6. شاشة الموصل (مهمة جارية) -->
    <div id="screen-rider-active" class="screen">
        <h3>تفاصيل الطلب</h3>
        <div class="order-card">
            <h4 id="act-food" style="margin:0">...</h4>
            <p id="act-store" style="color:#666;"></p>
            <p><i class="fas fa-user"></i> <span id="act-cust"></span></p>
            <a id="btn-call" href="#" style="display:block; text-align:center; background:#4CAF50; color:white; padding:8px; border-radius:5px; text-decoration:none;">اتصال بالزبون</a>
        </div>

        <div id="map-rider"></div>

        <div style="margin-top:15px;">
            <button onclick="updateStatus('heading_to_store')">1. في الطريق للمحل</button>
            <button onclick="updateStatus('ordered')">2. تم الشراء</button>
            <div style="background:#f9f9f9; padding:10px; margin:5px 0;">
                <small>3. صورة الفاتورة</small>
                <input type="file" id="invoice-file">
                <button onclick="uploadInvoice()" style="background:#555;">رفع</button>
            </div>
            <button onclick="updateStatus('delivering')">4. جاري التوصيل</button>
            <button onclick="updateStatus('completed')" style="background:#333;">5. تم التسليم</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, onValue, update, runTransaction, get, query, orderByChild, equalTo } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Config
        const firebaseConfig = {
            apiKey: "AIzaSyACuXD3szL8eudcmU5QtPWRT9Ha8k782DA",
            authDomain: "gouba-80f4c.firebaseapp.com",
            projectId: "gouba-80f4c",
            storageBucket: "gouba-80f4c.appspot.com",
            messagingSenderId: "640752558914",
            appId: "1:640752558914:web:75951a854ee68f4b3b1edb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // Variables
        let currentUser = null;
        let userData = null;
        let activeOrderData = null;
        let map = null, markers = {};
        let myOrderId = null;
        let riderWatchId = null;

        // --- Splash Logic ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 800);
            }, 2500); // تظهر لمدة 2.5 ثانية
        });

        // --- Auth Logic (Fixed) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // جلب البيانات مع التعامل مع الأخطاء
                get(ref(db, 'users/' + user.uid))
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        userData = snapshot.val();
                        if (userData.role === 'customer') {
                            showScreen('screen-customer');
                            document.getElementById('cust-welcome').innerText = "مرحباً " + userData.name;
                        } else {
                            showScreen('screen-rider-dashboard');
                            document.getElementById('rider-welcome').innerText = userData.name;
                            initRiderDashboard();
                        }
                    } else {
                        // حالة نادرة: الحساب موجود في Auth لكن بياناته محذوفة من Database
                        alert("خطأ: بيانات المستخدم غير موجودة. يرجى إنشاء حساب جديد.");
                        signOut(auth);
                        showScreen('screen-login');
                    }
                })
                .catch((error) => {
                    // هنا يتم حل مشكلة "التعليق" في حال فشل الاتصال بقاعدة البيانات
                    console.error(error);
                    alert("فشل الاتصال بقاعدة البيانات. تأكد من اتصال الإنترنت.");
                    document.getElementById('btn-login').innerText = "دخول";
                    document.getElementById('btn-login').disabled = false;
                });
            } else {
                // إذا لم يكن مسجلاً، اذهب لشاشة الدخول (بعد انتهاء السبلاش)
                // نستخدم Timeout بسيط لضمان عدم ظهورها فوق السبلاش فوراً
                setTimeout(() => {
                    if(document.getElementById('splash-screen').style.display === 'none') {
                        showScreen('screen-login'); 
                    } else {
                        // إذا السبلاش لا يزال يعمل، الشاشة ستظهر تحته تلقائياً
                        document.getElementById('screen-login').classList.add('active-screen');
                    }
                }, 100);
            }
        });

        window.handleLogin = () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const btn = document.getElementById('btn-login');
            const errBox = document.getElementById('login-error');

            if(!email || !pass) return;
            
            btn.innerText = "جاري الاتصال...";
            btn.disabled = true;
            errBox.style.display = 'none';

            signInWithEmailAndPassword(auth, email, pass)
            .catch((error) => {
                btn.innerText = "تسجيل الدخول";
                btn.disabled = false;
                let msg = "خطأ في المعلومات";
                if(error.code === 'auth/invalid-credential') msg = "البريد أو كلمة المرور خطأ";
                if(error.code === 'auth/network-request-failed') msg = "تأكد من الإنترنت";
                errBox.innerText = msg;
                errBox.style.display = 'block';
            });
            // ملاحظة: إذا نجح، onAuthStateChanged سيعمل تلقائياً
        };

        window.handleRegister = () => {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const role = document.getElementById('reg-role').value;
            const btn = document.getElementById('btn-register');
            
            if(!name || !phone || !email || !pass) { alert("أدخل كل المعلومات"); return; }
            
            btn.innerText = "جاري الانشاء...";
            btn.disabled = true;

            createUserWithEmailAndPassword(auth, email, pass)
            .then((cred) => {
                set(ref(db, 'users/' + cred.user.uid), {
                    name: name, phone: phone, role: role, email: email
                });
            })
            .catch((err) => {
                btn.innerText = "إنشاء الحساب";
                btn.disabled = false;
                document.getElementById('reg-error').innerText = err.message;
                document.getElementById('reg-error').style.display = 'block';
            });
        };

        window.logout = () => signOut(auth).then(() => window.location.reload());

        // --- Customer Functions ---
        window.createOrder = () => {
            const food = document.getElementById('food-name').value;
            const store = document.getElementById('store-name').value;
            if(!food || !store) return alert("أدخل اسم الأكل والمحل");

            document.getElementById('btn-order-now').style.display = 'none';
            document.getElementById('gps-loader').style.display = 'block';

            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const newOrd = push(ref(db, 'orders'));
                    myOrderId = newOrd.key;
                    set(newOrd, {
                        custId: currentUser.uid, custName: userData.name, custPhone: userData.phone,
                        food: food, drink: document.getElementById('drink-name').value, store: store,
                        lat: pos.coords.latitude, lng: pos.coords.longitude,
                        status: 'pending', price: 100
                    }).then(() => {
                        showScreen('screen-tracking');
                        initMap('map-customer', pos.coords.latitude, pos.coords.longitude);
                        trackMyOrder();
                    });
                }, (err) => {
                    alert("يجب تفعيل GPS (أو استخدم HTTPS)");
                    document.getElementById('btn-order-now').style.display = 'block';
                    document.getElementById('gps-loader').style.display = 'none';
                });
            }
        };

        function trackMyOrder() {
            onValue(ref(db, 'orders/' + myOrderId), (snap) => {
                const d = snap.val();
                if(!d) return;
                
                let st = d.status;
                if(st === 'accepted') st = "تم قبول الطلب!";
                if(st === 'delivering') st = "الموصل في الطريق إليك";
                if(st === 'completed') { alert("وصل الطلب!"); st = "تم الاستلام"; }
                
                document.getElementById('order-status-text').innerText = st;
                
                if(d.riderId) {
                    document.getElementById('rider-info-box').style.display = 'block';
                    document.getElementById('rider-name-display').innerText = d.riderName;
                    document.getElementById('rider-phone-display').innerText = d.riderPhone;
                    updateMapMarker('rider', d.riderLat, d.riderLng);
                }
                if(d.invoiceUrl) {
                    const img = document.getElementById('customer-invoice-view');
                    img.src = d.invoiceUrl;
                    img.style.display = 'block';
                }
            });
        }

        // --- Rider Functions ---
        function initRiderDashboard() {
            // New orders
            onValue(ref(db, 'orders'), (snap) => {
                const list = document.getElementById('orders-list');
                list.innerHTML = "";
                snap.forEach(c => {
                    const o = c.val();
                    if(o.status === 'pending') {
                        document.getElementById('notif-sound').play().catch(()=>{});
                        const div = document.createElement('div');
                        div.className = 'order-card';
                        div.innerHTML = `<h4>${o.food} (${o.price} DA)</h4><p>${o.store}</p>
                        <button onclick="window.takeOrder('${c.key}')">قبول</button>`;
                        list.appendChild(div);
                    }
                });
            });
            // Stats (Demo)
            document.getElementById('stat-comp').innerText = "5"; 
            document.getElementById('stat-earn').innerText = "500";
        }

        window.takeOrder = (key) => {
            runTransaction(ref(db, 'orders/' + key), (curr) => {
                if(curr && curr.status === 'pending') {
                    curr.status = 'accepted';
                    curr.riderId = currentUser.uid;
                    curr.riderName = userData.name;
                    curr.riderPhone = userData.phone;
                    return curr;
                }
            }).then((res) => {
                if(res.committed) {
                    activeOrderData = res.snapshot.val();
                    activeOrderData.key = key;
                    showScreen('screen-rider-active');
                    setupActiveOrder();
                }
            });
        };

        function setupActiveOrder() {
            document.getElementById('act-food').innerText = activeOrderData.food;
            document.getElementById('act-store').innerText = activeOrderData.store;
            document.getElementById('act-cust').innerText = activeOrderData.custName;
            document.getElementById('btn-call').href = "tel:" + activeOrderData.custPhone;
            
            initMap('map-rider', activeOrderData.lat, activeOrderData.lng);
            
            if(navigator.geolocation) {
                riderWatchId = navigator.geolocation.watchPosition(p => {
                    update(ref(db, 'orders/' + activeOrderData.key), {
                        riderLat: p.coords.latitude, riderLng: p.coords.longitude
                    });
                    updateMapMarker('rider', p.coords.latitude, p.coords.longitude);
                });
            }
        }

        window.updateStatus = (st) => {
            update(ref(db, 'orders/' + activeOrderData.key), { status: st });
            if(st === 'completed') {
                navigator.geolocation.clearWatch(riderWatchId);
                alert("تمت المهمة!");
                showScreen('screen-rider-dashboard');
            }
        };

        window.uploadInvoice = () => {
            const file = document.getElementById('invoice-file').files[0];
            if(!file) return;
            uploadBytes(sRef(storage, `inv/${Date.now()}`), file).then(s => {
                getDownloadURL(s.ref).then(url => {
                    update(ref(db, 'orders/' + activeOrderData.key), { invoiceUrl: url });
                    alert("تم الرفع");
                });
            });
        };

        // --- Helpers ---
        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
            setTimeout(() => { if(map) map.invalidateSize(); }, 300);
        };

        function initMap(div, lat, lng) {
            if(map) { map.remove(); markers={}; }
            map = L.map(div).setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markers['cust'] = L.marker([lat, lng]).addTo(map).bindPopup("الزبون").openPopup();
        }

        function updateMapMarker(type, lat, lng) {
            if(!map) return;
            const icon = L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/713/713311.png', iconSize:[40,40]});
            if(markers[type]) markers[type].setLatLng([lat, lng]);
            else markers[type] = L.marker([lat, lng], {icon: icon}).addTo(map);
            map.panTo([lat, lng]);
        }
    </script>
</body>
</html>
