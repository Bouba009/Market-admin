<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comondi - توصيل الطعام</title>
    
    <!-- الخرائط والأيقونات -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #FF5722;
            --secondary: #2196F3;
            --glass: rgba(255, 255, 255, 0.92);
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; overflow-x: hidden; color: #333; }

        /* --- 1. الخلفية المطلوبة مع أنيميشن الزووم --- */
        .bg-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden;
        }
        .bg-image {
            width: 100%; height: 100%;
            /* رابط الصورة التي أرسلتها */
            background: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjWOlDa6vJwlY7Rp8LxE9PIaKWpdIosG7fM2IJ3uH4uC8k3waiGlpnM_xmxN1lzSlwIpVVvIlTOyXMpqgnH-dOlC_5GL-yXvvlcF7QprL2xiHEa3ONg9kEto0OYlThB2DKm3rTySkII48PLJV_pDiIpjhAcKbiJZQYHKP8AJYY1eGGj0pNuWSi-cvABZUk/s3464/Picsart_26-02-04_18-02-43-362.png') no-repeat center center/cover;
            animation: zoomMove 20s infinite alternate linear;
        }
        @keyframes zoomMove {
            0% { transform: scale(1); }
            100% { transform: scale(1.3); }
        }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); }

        /* --- 2. الشاشات --- */
        .screen { display: none; padding: 20px; max-width: 500px; margin: 5vh auto; background: var(--glass); border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); backdrop-filter: blur(10px); min-height: 80vh; position: relative; }
        .active-screen { display: block; animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- 3. العناصر --- */
        h1, h2, h3 { text-align: center; color: var(--primary); margin-bottom: 15px; }
        input, select, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { background: #e64a19; }
        .lang-switch { position: absolute; top: 15px; left: 15px; z-index: 999; }
        .lang-btn { background: #fff; border: 1px solid #333; padding: 5px 10px; cursor: pointer; border-radius: 20px; font-weight: bold; font-size: 12px; }
        .active-lang { background: var(--primary); color: #fff; border: none; }

        /* خرائط */
        #map-cust, #map-rider { height: 250px; width: 100%; border-radius: 10px; margin-top: 10px; border: 2px solid #fff; }

        /* بطاقة الطلب للموصل */
        .order-card { background: #fff; border-right: 5px solid var(--primary); padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .price-tag { float: left; background: #4CAF50; color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.9em; }

        /* أنيميشن التحميل */
        .loader { width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }
        
        /* أيقونات البداية */
        .splash-icons { text-align: center; margin-bottom: 20px; font-size: 50px; }
        .fa-motorcycle { color: var(--primary); margin: 0 10px; animation: drive 2s infinite linear; }
        @keyframes drive { 0% { transform: translateX(0); } 50% { transform: translateX(5px) rotate(5deg); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>

    <!-- الخلفية -->
    <div class="bg-container">
        <div class="bg-image"></div>
        <div class="overlay"></div>
    </div>

    <!-- تبديل اللغة -->
    <div class="lang-switch">
        <button class="lang-btn active-lang" onclick="setLang('ar')">AR</button>
        <button class="lang-btn" onclick="setLang('fr')">FR</button>
    </div>

    <audio id="sound-notif" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <!-- 1. شاشة البداية / تسجيل الدخول -->
    <div id="screen-auth" class="screen active-screen">
        <div class="splash-icons">
            <i class="fas fa-user"></i> <i class="fas fa-motorcycle"></i>
        </div>
        <h1>Comondi</h1>
        <p style="text-align:center;" id="lbl-login-msg">سجل دخولك للمتابعة</p>
        
        <div id="login-form">
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="doLogin()" id="btn-login">دخول</button>
            <p style="text-align:center; cursor:pointer; color:var(--secondary); text-decoration:underline;" onclick="toggleAuth('register')" id="lnk-reg">انشاء حساب جديد</p>
        </div>

        <div id="register-form" class="hidden">
            <select id="role">
                <option value="customer" id="opt-cust">زبون (Client)</option>
                <option value="rider" id="opt-rider">موصل (Livreur)</option>
            </select>
            <input type="text" id="reg-name" placeholder="الاسم">
            <input type="tel" id="reg-phone" placeholder="الهاتف">
            <input type="email" id="reg-email" placeholder="Email">
            <input type="password" id="reg-pass" placeholder="Password">
            <button onclick="doRegister()" id="btn-reg">تسجيل</button>
            <p style="text-align:center; cursor:pointer; color:var(--secondary);" onclick="toggleAuth('login')" id="lnk-log">لديك حساب؟ دخول</p>
        </div>
        <div id="auth-loader" class="loader"></div>
        <p id="auth-error" style="color:red; text-align:center; display:none;"></p>
    </div>

    <!-- 2. شاشة الزبون (الطلب) -->
    <div id="screen-cust-order" class="screen">
        <div style="display:flex; justify-content:space-between;">
            <h3 id="lbl-welcome-c">أهلا</h3>
            <button onclick="doLogout()" style="width:auto; padding:5px 10px; background:#555;">خروج</button>
        </div>
        <hr>
        <h2 id="lbl-make-order">طلب جديد</h2>
        <input type="text" id="food" placeholder="اسم الأكل (Sandwich...)">
        <input type="text" id="store" placeholder="اسم المحل (ADM Food...)">
        <button onclick="makeOrder()" id="btn-order">اطلب وشارك الموقع GPS</button>
        <div id="gps-loader" class="loader"></div>
    </div>

    <!-- 3. شاشة الزبون (التتبع) -->
    <div id="screen-cust-track" class="screen">
        <h2 id="lbl-track">تتبع الطلب</h2>
        <div style="text-align:center; padding:10px; background:#e0f7fa; border-radius:5px;">
            <strong id="status-text">بانتظار القبول...</strong>
        </div>
        
        <div id="rider-details" class="hidden" style="margin-top:10px; background:#fff3e0; padding:10px; border-radius:5px;">
            <p><i class="fas fa-motorcycle"></i> <span id="r-name"></span></p>
            <p><i class="fas fa-phone"></i> <span id="r-phone"></span></p>
        </div>

        <div id="map-cust"></div>
        <img id="invoice-img" src="" style="width:100%; display:none; margin-top:10px; border-radius:5px; border:1px solid #ccc;">
    </div>

    <!-- 4. شاشة الموصل (داشبورد) -->
    <div id="screen-rider-dash" class="screen">
        <div style="display:flex; justify-content:space-between;">
            <h3 id="lbl-welcome-r">الداشبورد</h3>
            <button onclick="doLogout()" style="width:auto; background:#555; padding:5px 10px;"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        
        <!-- مربعات الإحصائيات -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:15px 0;">
            <div style="background:#fff; padding:10px; text-align:center; border-radius:8px;">
                <i class="fas fa-check-circle" style="color:green; font-size:20px;"></i>
                <h4 style="margin:5px 0">0</h4>
                <small id="lbl-done">مكتملة</small>
            </div>
            <div style="background:#fff; padding:10px; text-align:center; border-radius:8px;">
                <i class="fas fa-wallet" style="color:gold; font-size:20px;"></i>
                <h4 style="margin:5px 0">0 DA</h4>
                <small id="lbl-earn">الأرباح</small>
            </div>
        </div>

        <h3 style="border-bottom:1px solid #eee;" id="lbl-new-orders">طلبات جديدة</h3>
        <div id="orders-list">
            <p style="text-align:center; color:#777;">لا توجد طلبات</p>
        </div>
    </div>

    <!-- 5. شاشة الموصل (مهمة جارية) -->
    <div id="screen-rider-active" class="screen">
        <h2 id="lbl-mission">مهمة جارية</h2>
        <div class="order-card">
            <span class="price-tag">100 DA</span>
            <h3 id="act-food" style="margin:0 0 5px 0;"></h3>
            <p id="act-store" style="margin:0; color:#555;"></p>
            <hr>
            <p><i class="fas fa-user"></i> <span id="act-cust"></span></p>
            <p><i class="fas fa-phone"></i> <span id="act-phone"></span></p>
        </div>

        <div id="map-rider"></div>

        <div style="margin-top:15px;">
            <button onclick="upSt('heading_to_store')" id="btn-st1">1. في طريقي للمحل</button>
            <button onclick="upSt('ordered')" id="btn-st2">2. تم طلب احتياجكم</button>
            
            <div style="background:#f5f5f5; padding:10px; margin:5px 0; border-radius:5px;">
                <small id="lbl-inv">3. تصوير الفاتورة (للزبون)</small>
                <input type="file" id="file-inv" accept="image/*">
                <button onclick="upInv()" style="background:#333; margin-top:5px;">رفع الصورة</button>
            </div>

            <button onclick="upSt('delivering')" id="btn-st4">4. تم الاستلام وفي الطريق</button>
            <button onclick="upSt('completed')" style="background:green;" id="btn-st5">5. تم التوصيل بنجاح</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, onValue, update, runTransaction, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // إعدادات فايربيس (استخدم إعداداتك الخاصة هنا إذا توقف هذا عن العمل)
        const firebaseConfig = {
            apiKey: "AIzaSyACuXD3szL8eudcmU5QtPWRT9Ha8k782DA",
            authDomain: "gouba-80f4c.firebaseapp.com",
            projectId: "gouba-80f4c",
            storageBucket: "gouba-80f4c.appspot.com",
            messagingSenderId: "640752558914",
            appId: "1:640752558914:web:75951a854ee68f4b3b1edb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // متغيرات
        let user = null, userData = null;
        let map = null, markers = {};
        let activeOrder = null, myOrderId = null, watchId = null;
        let lang = 'ar';

        // نصوص اللغات
        const txt = {
            ar: { login:'دخول', reg:'تسجيل', email:'البريد', pass:'كلمة المرور', make:'طلب جديد', welcome:'أهلا', track:'تتبع الطلب', wait:'بانتظار القبول', accepted:'تم القبول', delivering:'الموصل قادم', completed:'تم التوصيل' },
            fr: { login:'Connexion', reg:'Inscription', email:'Email', pass:'Mot de passe', make:'Commander', welcome:'Bienvenue', track:'Suivi', wait:'En attente...', accepted:'Accepté', delivering:'En route', completed:'Livré' }
        };

        // --- دوال العرض ---
        window.setLang = (l) => {
            lang = l;
            document.dir = l=='ar'?'rtl':'ltr';
            document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active-lang'));
            event.target.classList.add('active-lang');
            // تحديث نصوص بسيطة كمثال
            document.getElementById('btn-login').innerText = txt[l].login;
        };

        window.show = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
            setTimeout(() => { if(map) map.invalidateSize(); }, 300);
        };

        window.toggleAuth = (mode) => {
            if(mode === 'register') {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
                document.getElementById('lbl-login-msg').innerText = "إنشاء حساب جديد";
            } else {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('lbl-login-msg').innerText = "سجل دخولك";
            }
        };

        // --- Auth Logic ---
        onAuthStateChanged(auth, (u) => {
            if(u) {
                user = u;
                get(ref(db, 'users/' + u.uid)).then(snap => {
                    userData = snap.val();
                    if(!userData) return; // Error handling
                    if(userData.role === 'customer') {
                        show('screen-cust-order');
                        document.getElementById('lbl-welcome-c').innerText = txt[lang].welcome + " " + userData.name;
                    } else {
                        show('screen-rider-dash');
                        initRider();
                    }
                });
            } else {
                show('screen-auth');
            }
        });

        window.doRegister = () => {
            const e = document.getElementById('reg-email').value;
            const p = document.getElementById('reg-pass').value;
            const n = document.getElementById('reg-name').value;
            const ph = document.getElementById('reg-phone').value;
            const r = document.getElementById('role').value;
            
            document.getElementById('auth-loader').style.display = 'block';
            createUserWithEmailAndPassword(auth, e, p).then(cred => {
                set(ref(db, 'users/' + cred.user.uid), { name:n, phone:ph, role:r, email:e });
                document.getElementById('auth-loader').style.display = 'none';
            }).catch(err => alert(err.message));
        };

        window.doLogin = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            document.getElementById('auth-loader').style.display = 'block';
            signInWithEmailAndPassword(auth, e, p).catch(err => {
                document.getElementById('auth-loader').style.display = 'none';
                alert("خطأ في الدخول: " + err.message);
            });
        };

        window.doLogout = () => signOut(auth).then(()=>window.location.reload());

        // --- Customer Logic ---
        window.makeOrder = () => {
            const f = document.getElementById('food').value;
            const s = document.getElementById('store').value;
            if(!f || !s) return alert("املأ البيانات");

            document.getElementById('gps-loader').style.display = 'block';
            if(!navigator.geolocation) return alert("GPS غير مدعوم");

            navigator.geolocation.getCurrentPosition(pos => {
                const newOrd = push(ref(db, 'orders'));
                myOrderId = newOrd.key;
                set(newOrd, {
                    custId: user.uid, custName: userData.name, custPhone: userData.phone,
                    food: f, store: s, price: 100, status: 'pending',
                    lat: pos.coords.latitude, lng: pos.coords.longitude
                }).then(() => {
                    show('screen-cust-track');
                    initMap('map-cust', pos.coords.latitude, pos.coords.longitude);
                    trackOrder();
                });
            }, err => {
                alert("فشل تحديد الموقع. تأكد أنك تستخدم HTTPS أو localhost");
                document.getElementById('gps-loader').style.display = 'none';
            });
        };

        function trackOrder() {
            onValue(ref(db, 'orders/' + myOrderId), snap => {
                const d = snap.val();
                if(!d) return;
                
                let st = d.status;
                if(st === 'accepted') st = txt[lang].accepted;
                if(st === 'delivering') st = txt[lang].delivering;
                if(st === 'completed') { st = txt[lang].completed; alert("تم التوصيل!"); }
                
                document.getElementById('status-text').innerText = st;

                if(d.riderId) {
                    document.getElementById('rider-details').classList.remove('hidden');
                    document.getElementById('r-name').innerText = d.riderName;
                    document.getElementById('r-phone').innerText = d.riderPhone;
                    
                    if(d.riderLat) updateMarker('rider', d.riderLat, d.riderLng);
                }

                if(d.invoiceUrl) {
                    const img = document.getElementById('invoice-img');
                    img.src = d.invoiceUrl;
                    img.style.display = 'block';
                }
            });
        }

        // --- Rider Logic ---
        function initRider() {
            onChildAdded(ref(db, 'orders'), snap => {
                const o = snap.val();
                if(o.status === 'pending') {
                    document.getElementById('sound-notif').play().catch(()=>{});
                    const div = document.createElement('div');
                    div.className = 'order-card';
                    div.id = 'ord-'+snap.key;
                    div.innerHTML = `<h3>${o.food}</h3><p>${o.store}</p><span class="price-tag">100 DA</span><br>
                    <button onclick="window.accept('${snap.key}')" style="margin-top:10px;">قبول (100 دج)</button>`;
                    document.getElementById('orders-list').appendChild(div);
                }
            });
            // إزالة الطلب إذا قبله آخر
            onValue(ref(db, 'orders'), snap => {
                document.getElementById('orders-list').innerHTML = "";
                snap.forEach(c => {
                    if(c.val().status === 'pending') {
                         // إعادة الرسم (تبسيط للكود)
                         const o = c.val();
                         const div = document.createElement('div');
                         div.className = 'order-card';
                         div.innerHTML = `<h3>${o.food}</h3><p>${o.store}</p><span class="price-tag">100 DA</span><br>
                         <button onclick="window.accept('${c.key}')" style="margin-top:10px;">قبول (100 دج)</button>`;
                         document.getElementById('orders-list').appendChild(div);
                    }
                });
            });
        }

        window.accept = (key) => {
            runTransaction(ref(db, 'orders/' + key), (cur) => {
                if(cur && cur.status === 'pending') {
                    cur.status = 'accepted';
                    cur.riderId = user.uid;
                    cur.riderName = userData.name;
                    cur.riderPhone = userData.phone;
                    return cur;
                }
            }).then(res => {
                if(res.committed) {
                    activeOrder = res.snapshot.val();
                    activeOrder.key = key;
                    show('screen-rider-active');
                    setupActive();
                } else {
                    alert("سبقك إليها آخر!");
                }
            });
        };

        function setupActive() {
            document.getElementById('act-food').innerText = activeOrder.food;
            document.getElementById('act-store').innerText = activeOrder.store;
            document.getElementById('act-cust').innerText = activeOrder.custName;
            document.getElementById('act-phone').innerText = activeOrder.custPhone;
            
            initMap('map-rider', activeOrder.lat, activeOrder.lng);
            
            if(navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(p => {
                    const lat = p.coords.latitude;
                    const lng = p.coords.longitude;
                    update(ref(db, 'orders/' + activeOrder.key), { riderLat: lat, riderLng: lng });
                    updateMarker('rider', lat, lng);
                    
                    // التحقق من الوصول (تجريبي)
                    const dist = getDist(lat, lng, activeOrder.lat, activeOrder.lng);
                    if(dist < 0.1) console.log("Near target"); 
                }, null, {enableHighAccuracy:true});
            }
        }

        window.upSt = (st) => {
            update(ref(db, 'orders/' + activeOrder.key), { status: st });
            alert("تم تغيير الحالة: " + st);
            if(st === 'completed') {
                navigator.geolocation.clearWatch(watchId);
                show('screen-rider-dash');
            }
        };

        window.upInv = () => {
            const file = document.getElementById('file-inv').files[0];
            if(!file) return;
            const r = sRef(storage, 'inv/' + Date.now());
            uploadBytes(r, file).then(s => getDownloadURL(s.ref)).then(url => {
                update(ref(db, 'orders/' + activeOrder.key), { invoiceUrl: url });
                alert("تم رفع الفاتورة");
            });
        };

        // --- Maps ---
        const icoCust = L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/4140/4140048.png', iconSize:[40,40]}); // Anime Person
        const icoBike = L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/3093/3093044.png', iconSize:[40,40]}); // Motorbike

        function initMap(div, lat, lng) {
            if(map) { map.remove(); markers={}; }
            map = L.map(div).setView([lat, lng], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markers['cust'] = L.marker([lat, lng], {icon:icoCust}).addTo(map).bindPopup("الزبون").openPopup();
        }

        function updateMarker(type, lat, lng) {
            if(!map) return;
            let ico = type==='rider' ? icoBike : icoCust;
            if(markers[type]) markers[type].setLatLng([lat, lng]);
            else markers[type] = L.marker([lat, lng], {icon:ico}).addTo(map);
            
            if(type==='rider') map.panTo([lat, lng]);
        }

        function getDist(lat1,lon1,lat2,lon2) {
            var R = 6371; 
            var dLat = (lat2-lat1) * (Math.PI/180);
            var dLon = (lon2-lon1) * (Math.PI/180); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c; 
        }

    </script>
</body>
</html>
