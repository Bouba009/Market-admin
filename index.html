<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comondi - توصيل الطلبات</title>
    
    <!-- مكتبة الخرائط Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- مكتبة الأيقونات FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #FF5722; /* لون برتقالي رئيسي */
            --secondary: #2196F3; /* لون أزرق ثانوي */
            --bg: #f4f6f8;
            --text: #333;
            --card-bg: #ffffff;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); }
        
        /* زر تغيير اللغة */
        .lang-switch { position: absolute; top: 15px; left: 15px; z-index: 2000; }
        .lang-btn { background: #fff; border: 1px solid #ccc; padding: 5px 12px; cursor: pointer; border-radius: 20px; font-weight: bold; font-size: 12px; }
        .lang-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        /* الشاشات */
        .screen { display: none; padding: 20px; max-width: 500px; margin: 0 auto; min-height: 100vh; background: var(--card-bg); box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        .active-screen { display: block; animation: fadeIn 0.4s ease-in-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2, h3 { text-align: center; color: var(--primary); margin-bottom: 15px; }
        
        /* النماذج والأزرار */
        .form-group { margin-bottom: 15px; }
        label { font-weight: bold; font-size: 0.9em; color: #555; display: block; margin-bottom: 5px; }
        input, select, button { width: 100%; padding: 12px; margin-top: 5px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 5px rgba(255, 87, 34, 0.2); }
        
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 15px; }
        button:hover { background: #E64A19; }
        button.secondary { background: #fff; color: #555; border: 1px solid #ddd; }
        button.secondary:hover { background: #f0f0f0; }

        /* روابط الدخول والتسجيل */
        .auth-link { text-align: center; margin-top: 20px; font-size: 0.9em; }
        .auth-link span { color: var(--secondary); cursor: pointer; text-decoration: underline; }

        /* لوحة تحكم الموصل (Dashboard Grid) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .stat-card i { font-size: 24px; margin-bottom: 8px; }
        .stat-card h4 { margin: 5px 0; font-size: 18px; color: #333; }
        .stat-card p { margin: 0; font-size: 11px; color: #888; }

        /* الخريطة */
        #map-customer, #map-rider { height: 300px; width: 100%; border-radius: 12px; margin-top: 15px; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* بطاقة الطلب */
        .order-card { background: #fff; border-right: 4px solid var(--primary); padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .price-badge { background: #4CAF50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; float: left; }

        /* أزرار الحالة */
        .status-steps button { margin-bottom: 8px; background: #f5f5f5; color: #333; text-align: right; padding-right: 15px; border: 1px solid #eee; }
        .status-steps button.active-step { background: var(--secondary); color: white; border-color: var(--secondary); }
        .status-steps button.done { background: #81C784; color: white; cursor: default; border-color: #81C784; }

        /* الفاتورة ورسائل الخطأ */
        #invoice-preview, #customer-invoice-view { max-width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid #ddd; display: none; }
        .error-msg { color: #d32f2f; font-size: 0.85em; text-align: center; display: none; margin-top: 8px; background: #ffebee; padding: 5px; border-radius: 4px; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- تبديل اللغة -->
    <div class="lang-switch">
        <button class="lang-btn active" onclick="setLang('ar')">AR</button>
        <button class="lang-btn" onclick="setLang('fr')">FR</button>
    </div>

    <!-- صوت الإشعار -->
    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <!-- 1. شاشة تسجيل الدخول -->
    <div id="screen-login" class="screen active-screen">
        <br><br>
        <h1>Comondi</h1>
        <h3 id="txt-login-title">تسجيل الدخول</h3>
        
        <input type="email" id="login-email" placeholder="البريد الإلكتروني (Email)">
        <input type="password" id="login-pass" placeholder="كلمة المرور (Password)">
        
        <p id="login-error" class="error-msg"></p>
        <button onclick="handleLogin()" id="btn-login">دخول</button>
        
        <div class="auth-link">
            <span onclick="showScreen('screen-register')" id="lnk-create-acc">ليس لديك حساب؟ إنشاء حساب جديد</span>
        </div>
    </div>

    <!-- 2. شاشة إنشاء حساب (مع حل مشكلة التكرار) -->
    <div id="screen-register" class="screen">
        <br>
        <h1>Comondi</h1>
        <h3 id="txt-reg-title">إنشاء حساب جديد</h3>
        
        <div class="form-group">
            <label id="lbl-role">أنت تسجل كـ:</label>
            <select id="reg-role">
                <option value="customer" id="opt-customer">زبون (Client)</option>
                <option value="rider" id="opt-rider">موصل (Livreur)</option>
            </select>
        </div>

        <input type="text" id="reg-name" placeholder="الاسم الكامل">
        <input type="tel" id="reg-phone" placeholder="رقم الهاتف">
        <input type="email" id="reg-email" placeholder="البريد الإلكتروني">
        <input type="password" id="reg-pass" placeholder="كلمة المرور (6 أحرف على الأقل)">
        
        <p id="reg-error" class="error-msg"></p>
        <button onclick="handleRegister()" id="btn-register">تسجيل</button>
        
        <div class="auth-link">
            <span onclick="showScreen('screen-login')" id="lnk-have-acc">لديك حساب؟ تسجيل دخول</span>
        </div>
    </div>

    <!-- 3. شاشة الزبون: طلب جديد -->
    <div id="screen-customer" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="txt-welcome-cust" style="margin:0; font-size:1.2em;">أهلاً</h2>
            <button onclick="logout()" class="secondary" style="width:auto; margin:0; padding:5px 12px; font-size:0.8em;">خروج</button>
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        
        <h3 id="txt-new-order">طلب جديد</h3>
        
        <div class="form-group">
            <label id="lbl-food">ماذا تريد أن تأكل؟</label>
            <input type="text" id="food-name" placeholder="مثال: Tacos, Pizza...">
        </div>
        
        <div class="form-group">
            <label id="lbl-drink">المشروب (اختياري)</label>
            <input type="text" id="drink-name" placeholder="مثال: Coca Cola...">
        </div>

        <div class="form-group">
            <label id="lbl-store">اسم المحل</label>
            <input type="text" id="store-name" placeholder="مثال: Adm Food...">
        </div>
        
        <button onclick="createOrder()" id="btn-order-now">اطلب وشارك موقعك GPS</button>
        <div id="gps-loader" class="loader"></div>
        <p id="gps-error" class="error-msg"></p>
    </div>

    <!-- 4. شاشة الزبون: تتبع الطلب -->
    <div id="screen-tracking" class="screen">
        <h2 id="txt-tracking">تتبع طلبك</h2>
        
        <div style="text-align:center; padding:15px; background:#e3f2fd; border-radius:8px; border:1px solid #bbdefb;">
            <p style="margin:0; font-weight:bold; color:var(--secondary); font-size:1.1em;" id="order-status-text">بانتظار القبول...</p>
        </div>
        
        <div id="rider-info-box" class="hidden" style="margin-top:10px; padding:10px; background:#fff3e0; border-radius:8px; display:none;">
            <p style="margin:5px 0"><i class="fas fa-motorcycle"></i> <strong>الموصل:</strong> <span id="rider-name-display">...</span></p>
            <p style="margin:5px 0"><i class="fas fa-phone"></i> <span id="rider-phone-display">...</span></p>
        </div>

        <div id="map-customer"></div>
        
        <div id="invoice-area" class="hidden" style="display:none;">
            <h3 id="txt-invoice" style="margin-top:20px;">فاتورة المشتريات</h3>
            <img id="customer-invoice-view" src="" alt="Invoice">
        </div>
    </div>

    <!-- 5. شاشة الموصل: لوحة التحكم -->
    <div id="screen-rider-dashboard" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0;" id="txt-dash">لوحة التحكم</h2>
            <button onclick="logout()" class="secondary" style="width:auto; margin:0; padding:5px 12px;"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        <p style="text-align:center; color:#777; font-size:0.9em; margin-bottom:15px;" id="rider-welcome-name">...</p>

        <!-- احصائيات 2x2 -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <i class="fas fa-check-circle" style="color:var(--secondary);"></i>
                <h4 id="stat-completed">0</h4>
                <p id="txt-stat-comp">طلبات مكتملة</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-wallet" style="color:#4CAF50;"></i>
                <h4 id="stat-earnings">0 DA</h4>
                <p id="txt-stat-earn">الأرباح</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-star" style="color:#FFC107;"></i>
                <h4>4.8</h4>
                <p id="txt-stat-rate">التقييم</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-wifi" style="color:var(--primary);"></i>
                <h4 id="txt-online" style="font-size:16px; margin-top:8px;">متصل</h4>
                <p id="txt-stat-st">الحالة</p>
            </div>
        </div>

        <h3 style="text-align:right; font-size:1.1em; border-bottom:2px solid #eee; padding-bottom:5px;" id="txt-avail-orders">الطلبات الواردة</h3>
        <div id="orders-list">
            <p style="text-align:center; color:#999; margin-top:30px;" id="txt-no-orders">لا توجد طلبات حالياً...</p>
        </div>
    </div>

    <!-- 6. شاشة الموصل: المهمة الجارية -->
    <div id="screen-rider-active" class="screen">
        <h3 id="txt-mission">المهمة الحالية</h3>
        
        <div class="order-card" style="border-color:var(--secondary);">
            <div style="display:flex; justify-content:space-between;">
                <h4 style="margin:0" id="active-store">Store</h4>
                <span style="background:var(--secondary); color:#fff; padding:2px 8px; border-radius:4px;">100 DA</span>
            </div>
            <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
            <p style="margin:5px 0;"><strong><i class="fas fa-hamburger"></i>:</strong> <span id="active-food"></span></p>
            <p style="margin:5px 0;"><strong><i class="fas fa-wine-bottle"></i>:</strong> <span id="active-drink">--</span></p>
            <p style="margin:5px 0;"><strong><i class="fas fa-user"></i>:</strong> <span id="active-cust-name">...</span></p>
            
            <a id="btn-call-cust" href="#" style="display:block; text-align:center; background:#4CAF50; color:white; padding:10px; text-decoration:none; border-radius:5px; margin-top:10px; font-weight:bold;">
                <i class="fas fa-phone"></i> اتصال بالزبون
            </a>
        </div>

        <div id="map-rider"></div>

        <div class="status-steps" style="margin-top:20px;">
            <p style="font-size:0.9em; color:#666; margin-bottom:5px;">تحديث حالة الطلب:</p>
            
            <button onclick="updateStatus('heading_to_store')" id="btn-st-1">1. أنا في الطريق للمحل</button>
            <button onclick="updateStatus('ordered')" id="btn-st-2">2. تم شراء الطلب</button>
            
            <!-- رفع الفاتورة -->
            <div style="background:#fff; padding:10px; border-radius:8px; margin-bottom:8px; border:1px dashed #ccc;">
                <label style="font-size:0.85em; margin-bottom:5px;">3. تصوير الفاتورة (لإظهارها للزبون)</label>
                <input type="file" id="invoice-file" accept="image/*" style="font-size:0.8em; padding:5px;">
                <button onclick="uploadInvoice()" id="btn-upload" class="secondary" style="margin-top:5px; width:auto; font-size:0.85em;">رفع الصورة</button>
                <img id="invoice-preview" src="">
            </div>

            <button onclick="updateStatus('delivering')" id="btn-st-4">4. تم الاستلام، أنا قادم إليك</button>
            <button onclick="updateStatus('completed')" id="btn-st-5" style="background:#333; color:#fff;">5. تم التوصيل (إنهاء)</button>
        </div>
    </div>

    <!-- كود الجافاسكريبت والفايربيس -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, onValue, update, runTransaction, get, query, orderByChild, equalTo } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // إعدادات فايربيس الخاصة بك
        const firebaseConfig = {
            apiKey: "AIzaSyACuXD3szL8eudcmU5QtPWRT9Ha8k782DA",
            authDomain: "gouba-80f4c.firebaseapp.com",
            projectId: "gouba-80f4c",
            storageBucket: "gouba-80f4c.appspot.com",
            messagingSenderId: "640752558914",
            appId: "1:640752558914:web:75951a854ee68f4b3b1edb"
        };

        // تهيئة فايربيس
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        
        // متغيرات عامة
        let currentUser = null;
        let userData = null;
        let currentLang = 'ar';
        let myOrderId = null;
        let riderWatchId = null;
        let activeOrderData = null;
        let map = null, markers = {};
        
        // نصوص الترجمة
        const texts = {
            ar: {
                loginTitle: "تسجيل الدخول", regTitle: "إنشاء حساب جديد",
                cust: "زبون", rider: "موصل",
                newOrder: "طلب جديد", food: "الأكل", drink: "المشروب", store: "المحل",
                orderBtn: "اطلب وشارك موقعك", track: "تتبع الطلب",
                waiting: "بانتظار القبول...", accepted: "تم قبول الطلب",
                dash: "لوحة التحكم", avail: "الطلبات الواردة",
                comp: "طلبات مكتملة", earn: "الأرباح", rate: "التقييم", st: "الحالة",
                mission: "المهمة الحالية", noOrders: "لا توجد طلبات...",
                online: "متصل"
            },
            fr: {
                loginTitle: "Connexion", regTitle: "Créer un compte",
                cust: "Client", rider: "Livreur",
                newOrder: "Nouvelle Commande", food: "Plat", drink: "Boisson", store: "Magasin",
                orderBtn: "Commander & Partager GPS", track: "Suivi",
                waiting: "En attente...", accepted: "Commande acceptée",
                dash: "Tableau de bord", avail: "Commandes reçues",
                comp: "Commandes finies", earn: "Gains", rate: "Avis", st: "Statut",
                mission: "Mission en cours", noOrders: "Aucune commande...",
                online: "En ligne"
            }
        };

        // --- دوال المصادقة (Auth) ---
        
        // دالة إنشاء الحساب (المحسنة مع معالجة الأخطاء)
        window.handleRegister = () => {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const role = document.getElementById('reg-role').value;
            const errBox = document.getElementById('reg-error');
            const btn = document.getElementById('btn-register');

            if(!email || !pass || !name || !phone) {
                errBox.innerText = "يرجى ملء جميع الحقول"; errBox.style.display='block'; return;
            }

            btn.disabled = true;
            btn.innerText = "جاري التسجيل...";

            createUserWithEmailAndPassword(auth, email, pass)
            .then((userCredential) => {
                const uid = userCredential.user.uid;
                // حفظ بيانات المستخدم في قاعدة البيانات
                set(ref(db, 'users/' + uid), {
                    name: name,
                    phone: phone,
                    role: role,
                    email: email
                }).then(() => {
                    // الانتقال التلقائي سيحدث عبر مراقب الحالة
                });
            })
            .catch((error) => {
                btn.disabled = false;
                btn.innerText = "تسجيل";
                
                let msg = "حدث خطأ غير معروف";
                // ترجمة الأخطاء
                if (error.code === 'auth/email-already-in-use') {
                    msg = "هذا البريد الإلكتروني مسجل بالفعل! حاول تسجيل الدخول.";
                } else if (error.code === 'auth/weak-password') {
                    msg = "كلمة المرور ضعيفة (يجب أن تكون 6 خانات على الأقل).";
                } else if (error.code === 'auth/invalid-email') {
                    msg = "صيغة البريد الإلكتروني غير صحيحة.";
                } else if (error.code === 'auth/network-request-failed') {
                    msg = "تأكد من اتصالك بالإنترنت.";
                }

                errBox.innerText = msg;
                errBox.style.display='block';
            });
        };

        // دالة تسجيل الدخول
        window.handleLogin = () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const errBox = document.getElementById('login-error');
            const btn = document.getElementById('btn-login');

            if(!email || !pass) { errBox.innerText = "أدخل البريد وكلمة المرور"; errBox.style.display='block'; return; }

            btn.disabled = true; 
            btn.innerText = "جاري الدخول...";

            signInWithEmailAndPassword(auth, email, pass)
            .catch((error) => {
                btn.disabled = false;
                btn.innerText = "دخول";
                let msg = "خطأ في البريد أو كلمة المرور";
                if(error.code === 'auth/network-request-failed') msg = "تأكد من الانترنت";
                errBox.innerText = msg;
                errBox.style.display='block';
            });
        };

        window.logout = () => {
            signOut(auth).then(() => window.location.reload());
        };

        // مراقب حالة الدخول (يوجه المستخدم للشاشة المناسبة)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                get(ref(db, 'users/' + user.uid)).then((snapshot) => {
                    if (snapshot.exists()) {
                        userData = snapshot.val();
                        if (userData.role === 'customer') {
                            showScreen('screen-customer');
                            document.getElementById('txt-welcome-cust').innerText = "مرحباً " + userData.name;
                        } else {
                            showScreen('screen-rider-dashboard');
                            document.getElementById('rider-welcome-name').innerText = userData.name;
                            initRiderDashboard();
                        }
                    } else {
                         // في حال تم حذف المستخدم من قاعدة البيانات وبقي في Auth
                        showScreen('screen-login');
                    }
                });
            } else {
                showScreen('screen-login');
            }
        });

        // --- منطق الزبون (Customer) ---
        window.createOrder = () => {
            const food = document.getElementById('food-name').value;
            const drink = document.getElementById('drink-name').value;
            const store = document.getElementById('store-name').value;
            const errBox = document.getElementById('gps-error');
            const loader = document.getElementById('gps-loader');

            if(!food || !store) {
                alert("يرجى إدخال اسم الأكل واسم المحل");
                return;
            }

            errBox.style.display = 'none';
            loader.style.display = 'block';
            document.getElementById('btn-order-now').disabled = true;

            if (!navigator.geolocation) {
                handleLocationError("المتصفح لا يدعم GPS");
                return;
            }

            // طلب الموقع
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                const newOrderRef = push(ref(db, 'orders'));
                myOrderId = newOrderRef.key;

                set(newOrderRef, {
                    customerId: currentUser.uid,
                    customerName: userData.name,
                    customerPhone: userData.phone,
                    foodName: food,
                    drinkName: drink || "",
                    storeName: store,
                    customerLat: lat,
                    customerLng: lng,
                    status: 'pending',
                    price: 100,
                    timestamp: Date.now()
                }).then(() => {
                    loader.style.display = 'none';
                    showScreen('screen-tracking');
                    initMap('map-customer', lat, lng, false);
                    listenToMyOrder();
                });

            }, (error) => {
                let msg = "فشل تحديد الموقع.";
                if(error.code === 1) msg = "يجب السماح للموقع من إعدادات المتصفح.";
                else if(error.code === 2) msg = "تأكد من تشغيل GPS.";
                // رسالة خاصة بمشكلة HTTP
                if(window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    msg += " (ملاحظة: GPS لا يعمل إلا على HTTPS)";
                }
                handleLocationError(msg);
            }, { enableHighAccuracy: true });
        };

        function handleLocationError(msg) {
            document.getElementById('gps-loader').style.display = 'none';
            document.getElementById('btn-order-now').disabled = false;
            document.getElementById('gps-error').innerText = msg;
            document.getElementById('gps-error').style.display = 'block';
            alert(msg);
        }

        function listenToMyOrder() {
            const orderRef = ref(db, 'orders/' + myOrderId);
            onValue(orderRef, (snapshot) => {
                const data = snapshot.val();
                if(!data) return;

                const statusTxt = document.getElementById('order-status-text');
                
                let stDisp = data.status;
                if(stDisp === 'pending') stDisp = texts[currentLang].waiting;
                else if(stDisp === 'completed') {
                    stDisp = "تم التوصيل بنجاح!";
                    alert("وصل طلبك! شكراً لاستخدام Comondi");
                } else {
                    stDisp = texts[currentLang].accepted;
                    // عرض بيانات الموصل
                    if(data.riderName) {
                        document.getElementById('rider-info-box').style.display = 'block';
                        document.getElementById('rider-name-display').innerText = data.riderName;
                        document.getElementById('rider-phone-display').innerText = data.riderPhone;
                    }
                    if(data.riderLat) {
                        updateMarker('rider', data.riderLat, data.riderLng);
                    }
                }
                statusTxt.innerText = stDisp;

                // عرض الفاتورة
                if(data.invoiceUrl) {
                    document.getElementById('invoice-area').style.display = 'block';
                    document.getElementById('customer-invoice-view').src = data.invoiceUrl;
                    document.getElementById('customer-invoice-view').style.display = 'block';
                }
            });
        }

        // --- منطق الموصل (Rider) ---
        function initRiderDashboard() {
            // حساب الإحصائيات
            const ordersQuery = query(ref(db, 'orders'), orderByChild('riderId'), equalTo(currentUser.uid));
            onValue(ordersQuery, (snapshot) => {
                let completedCount = 0;
                snapshot.forEach(child => {
                    if(child.val().status === 'completed') completedCount++;
                });
                document.getElementById('stat-completed').innerText = completedCount;
                document.getElementById('stat-earnings').innerText = (completedCount * 100) + " DA";
            });

            // الاستماع للطلبات الجديدة
            const allOrdersRef = ref(db, 'orders');
            onValue(allOrdersRef, (snap) => {
                const list = document.getElementById('orders-list');
                list.innerHTML = ""; 
                let hasOrders = false;

                snap.forEach(child => {
                    const o = child.val();
                    const key = child.key;
                    if(o.status === 'pending') {
                        hasOrders = true;
                        // تشغيل صوت عند ظهور طلب جديد في القائمة
                        // (ملاحظة: المتصفحات قد تمنع الصوت بدون تفاعل مسبق)
                        
                        const div = document.createElement('div');
                        div.className = 'order-card';
                        div.innerHTML = `
                            <div style="overflow:hidden; margin-bottom:5px;">
                                <span class="price-badge">${o.price} DA</span>
                                <h4 style="margin:0 10px; display:inline-block;">${o.foodName}</h4>
                            </div>
                            <p style="font-size:0.9em; color:#666; margin:5px 0;">
                                <i class="fas fa-store"></i> ${o.storeName}<br>
                                <i class="fas fa-user"></i> ${o.customerName}
                            </p>
                            <button onclick="window.acceptOrder('${key}')">قبول الطلب</button>
                        `;
                        list.appendChild(div);
                    }
                });

                if(!hasOrders) list.innerHTML = `<p style="text-align:center;color:#999;margin-top:30px;">${texts[currentLang].noOrders}</p>`;
            });
        }

        window.acceptOrder = (orderId) => {
            document.getElementById('notif-sound').play().catch(()=>{}); // محاولة تشغيل الصوت
            const orderRef = ref(db, 'orders/' + orderId);
            
            runTransaction(orderRef, (currentData) => {
                if (currentData && currentData.status === 'pending') {
                    currentData.status = 'accepted';
                    currentData.riderId = currentUser.uid;
                    currentData.riderName = userData.name;
                    currentData.riderPhone = userData.phone;
                    return currentData;
                } else {
                    return; // تم قبوله من شخص آخر
                }
            }).then((result) => {
                if (result.committed) {
                    activeOrderData = result.snapshot.val();
                    activeOrderData.key = orderId;
                    startMission();
                } else {
                    alert("عذراً، تم قبول الطلب من شخص آخر.");
                }
            });
        };

        function startMission() {
            showScreen('screen-rider-active');
            
            document.getElementById('active-store').innerText = activeOrderData.storeName;
            document.getElementById('active-food').innerText = activeOrderData.foodName;
            document.getElementById('active-drink').innerText = activeOrderData.drinkName || "--";
            document.getElementById('active-cust-name').innerText = activeOrderData.customerName;
            document.getElementById('btn-call-cust').href = "tel:" + activeOrderData.customerPhone;

            initMap('map-rider', activeOrderData.customerLat, activeOrderData.customerLng, true);

            // بدء تتبع موقع الموصل
            if(navigator.geolocation) {
                riderWatchId = navigator.geolocation.watchPosition((pos) => {
                    const rLat = pos.coords.latitude;
                    const rLng = pos.coords.longitude;

                    updateMarker('rider', rLat, rLng);
                    
                    update(ref(db, 'orders/' + activeOrderData.key), {
                        riderLat: rLat,
                        riderLng: rLng
                    });

                }, null, {enableHighAccuracy: true});
            }
        }

        window.updateStatus = (newSt) => {
            if(!activeOrderData) return;
            
            const btnIdMap = {'heading_to_store':'btn-st-1', 'ordered':'btn-st-2', 'delivering':'btn-st-4', 'completed':'btn-st-5'};
            if(btnIdMap[newSt]) document.getElementById(btnIdMap[newSt]).classList.add('done');

            update(ref(db, 'orders/' + activeOrderData.key), { status: newSt });

            if(newSt === 'completed') {
                if(riderWatchId) navigator.geolocation.clearWatch(riderWatchId);
                alert("عمل رائع! تم إنهاء المهمة.");
                setTimeout(() => {
                    showScreen('screen-rider-dashboard');
                }, 2000);
            }
        };

        window.uploadInvoice = () => {
            const file = document.getElementById('invoice-file').files[0];
            const btn = document.getElementById('btn-upload');
            if(!file) return alert("اختر صورة أولاً");
            
            btn.innerText = "جاري الرفع...";
            const sRefImg = sRef(storage, 'invoices/' + activeOrderData.key + '_' + Date.now());
            
            uploadBytes(sRefImg, file).then((snap) => {
                getDownloadURL(snap.ref).then((url) => {
                    update(ref(db, 'orders/' + activeOrderData.key), { invoiceUrl: url });
                    document.getElementById('invoice-preview').src = url;
                    document.getElementById('invoice-preview').style.display = 'block';
                    btn.innerText = "تم الرفع بنجاح";
                    btn.disabled = true;
                });
            }).catch(err => {
                alert("فشل الرفع: " + err.message);
                btn.innerText = "حاول مرة أخرى";
            });
        };

        // --- أدوات مساعدة ---
        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
            setTimeout(() => { if(map) map.invalidateSize(); }, 500);
        };

        window.setLang = (l) => {
            currentLang = l;
            document.dir = l === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            for (const [key, val] of Object.entries(texts[l])) {
                const el = document.getElementById('txt-' + key) || document.getElementById('lbl-' + key);
                if(el) el.innerText = val;
            }
        };

        // إعداد الخرائط
        const custIcon = L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/3003/3003984.png', iconSize:[40,40]}); // أيقونة الزبون
        const bikeIcon = L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/713/713311.png', iconSize:[40,40]}); // أيقونة الدراجة

        function initMap(divId, lat, lng, isRiderView) {
            if(map) { map.remove(); markers = {}; }
            map = L.map(divId).setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            markers['customer'] = L.marker([lat, lng], {icon: custIcon}).addTo(map)
                .bindPopup(isRiderView ? "الزبون" : "موقعك").openPopup();
        }

        function updateMarker(type, lat, lng) {
            if(!map) return;
            if(markers[type]) {
                markers[type].setLatLng([lat, lng]);
            } else {
                let icon = type === 'rider' ? bikeIcon : custIcon;
                markers[type] = L.marker([lat, lng], {icon: icon}).addTo(map);
            }
            if(type === 'rider') map.panTo([lat, lng]);
        }
    </script>
</body>
</html>
